# DramLog 개발 규칙

## 프로젝트 개요
- **프로젝트**: DramLog - 위스키 리뷰/게시글 커뮤니티 웹사이트
- **기술 스택**: SvelteKit + Tailwind CSS + Supabase
- **렌더링**: 서버사이드 렌더링(SSR) 기반
- **개발 모드**: 1인 개발 기준

## 핵심 원칙
- **Tailwind CSS만 사용**: 일반 CSS 작성 최소화, Tailwind 유틸리티 클래스 적극 활용
- **컴포넌트 분리**: 작은 단위로 컴포넌트 분리, 재사용성 고려
- **SvelteKit 규칙 준수**: `+page.svelte`, `+layout.svelte`, `+page.server.ts` 등 파일 기반 라우팅 규칙 준수
- **Supabase 사용**: 데이터베이스는 Supabase 사용 (PostgreSQL16 기반)
- **서버 전용 클라이언트**: `src/lib/server/supabase/client.ts`에서만 Supabase 클라이언트 생성
- **보안**: Service Role Key 절대 사용 금지, 클라이언트 노출 금지
- **익명/로그인 구분 개발**: 로그인 필요 없는 익명 사용자와 로그인 사용자를 구분하여 작동하도록 코드 작성
  - 예시: `/write` 페이지에서 `$page.data.user`로 로그인 여부 확인
  - 로그인 사용자: 닉네임 자동 적용, 비밀번호 입력 불필요, `user_id`로 수정/삭제
  - 익명 사용자: 작성자 선택 입력, 비밀번호 필수, 비밀번호로 수정/삭제
  - 같은 페이지/라우트에서 조건부 렌더링과 서버 로직 분기로 구현
  - **권한 정책(강제)**:
    - 로그인 글(`user_id` 존재): 작성자 본인만 수정/삭제 가능 (비밀번호 입력 없음)
    - 익명 글(`user_id` 없음): **로그아웃 상태에서만** 비밀번호로 수정/삭제 가능 (로그인 상태에서는 수정/삭제 불가)

## 코딩 스타일
- 들여쓰기: 2 spaces
- 변수명: camelCase
- 컴포넌트명: PascalCase
- 주석: 한국어로 작성
- Tailwind 클래스: 의미있는 그룹핑, 가독성 고려

## 파일 구조 (SvelteKit)
```
src/
├── routes/
│   ├── +layout.svelte (공통 레이아웃)
│   ├── +page.svelte (메인 페이지)
│   ├── posts/
│   │   ├── +page.svelte (게시글 리스트)
│   │   └── [id]/
│   │       └── +page.svelte (게시글 상세)
│   └── write/
│       └── +page.svelte (글 작성)
├── lib/
│   ├── components/ (재사용 컴포넌트)
│   │   ├── Header.svelte
│   │   ├── Footer.svelte
│   │   └── PostCard.svelte
│   └── server/ (서버 전용 코드)
│       └── supabase/
│           ├── client.ts (Supabase 클라이언트 생성)
│           ├── types.ts (타입 정의)
│           └── queries/
│               └── posts.ts (게시글 쿼리 함수)
└── app.html
```

## MVP 기능 (현재 단계 - 완료 ✅)
1. ✅ 메인 페이지: 커뮤니티 소개 + 최신 글 목록
2. ✅ 게시글 리스트 페이지
3. ✅ 게시글 상세 페이지
4. ✅ 글 작성 페이지 (Supabase 저장)
5. ✅ 공통 레이아웃 (헤더/푸터)
6. ✅ PostgreSQL 16 설치 및 데이터베이스 생성 완료 (레거시)
7. ✅ PostgreSQL 연결 및 마이그레이션 구현 (레거시)
8. ✅ 데이터베이스 스키마 생성 (posts 테이블)
9. ✅ 게시글 CRUD 기능 (생성, 조회, 목록)
10. ✅ 프로젝트 이름 DramLog로 통일
11. ✅ 날짜 2026-01-20 기준으로 업데이트
12. ✅ Supabase 통합 (글 작성/목록/상세 - 완전 전환 완료)
13. ✅ 게시글 수정 기능 (`/posts/[id]/edit`)
14. ✅ 게시글 삭제 기능 (상세 페이지)

## 다음 단계 (우선순위 순)

### MVP 3단계: 게시글 관리 기능 (완료 ✅)
1. ✅ **게시글 수정 기능**
   - `/posts/[id]/edit` 라우트 생성 완료
   - 수정 폼 페이지 (`+page.svelte`) 구현 완료
   - 서버 액션으로 업데이트 (`updatePost` 함수) 구현 완료
   - 현재는 모든 사용자 수정 가능 (인증 전 단계)

2. ✅ **게시글 삭제 기능**
   - 게시글 상세 페이지에 삭제 버튼 추가 완료
   - 서버 액션으로 삭제 (`deletePost` 함수) 구현 완료
   - 삭제 확인 다이얼로그 (confirm) 구현 완료
   - 현재는 모든 사용자 삭제 가능 (인증 전 단계)

3. ✅ **쿼리 함수 추가**
   - `src/lib/server/supabase/queries/posts.ts`에 `updatePost`, `deletePost` 함수 구현 완료

### MVP 4단계: 익명 게시판 + 선택 로그인 (개인 DB) (완료 ✅)
1. ✅ **익명 게시글 작성 기능**
   - 로그인 없이 게시글 작성 가능
   - 기본 작성자명: `익명의 위스키 러버` (작성자명 입력은 선택사항)
   - 게시글 작성 시 비밀번호 필수 입력 (수정/삭제용)

2. ✅ **게시글 비밀번호 관리**
   - `posts` 테이블에 `edit_password_hash TEXT` 컬럼 추가
   - 서버에서 비밀번호를 scrypt 해시로 저장 (평문 저장 금지)
   - 수정/삭제 시 비밀번호 검증 (timing-safe 비교)

3. ✅ **데이터베이스 스키마**
   - `author_name TEXT NOT NULL DEFAULT '익명의 위스키 러버'`
   - `edit_password_hash TEXT` (익명 글이면 값 존재)
   - `user_id UUID` (선택 로그인 도입 시 사용, 게스트 글 Claim 없음)

4. ✅ **구현 완료**
   - `/write`: 비밀번호 입력 필드 추가, 작성자명 기본값 적용
   - `/posts/[id]/edit`: 비밀번호 입력 필드 추가, 비밀번호 검증
   - `/posts/[id]`: 삭제 시 비밀번호 입력 모달/폼, 비밀번호 검증
   - 쿼리 계층: `createPost()`, `updatePost()`, `deletePost()`에 비밀번호 해시/검증 로직 추가

5. ✅ **선택 로그인 기능** (Supabase Auth)
   - 라우트: `/login`, `/signup`, `/logout`, `/my-posts`
   - 로그인은 개인 DB(보유 위스키, 북마크 등)용으로만 사용
   - 내 글 목록: `/my-posts` (posts.user_id 기반)
   - **로그인 사용자 글 작성**: 닉네임(`user_metadata.nickname`) 자동 적용, 비밀번호 입력 불필요, `user_id`로 수정/삭제
   - **익명 글 작성**: 작성자 선택 입력, 비밀번호 필수, 비밀번호로 수정/삭제
   - 같은 페이지(`/write`)에서 로그인 여부에 따라 UI/로직 자동 분기
   - 게스트 글 Claim 기능 없음 (익명 글은 계속 익명 소유)

### MVP 5단계: 핵심 기능 강화 (완료 ✅)
1. ✅ **검색 기능**
   - **파일 구조**:
     ```
     src/
     ├── routes/
     │   └── search/
     │       ├── +page.svelte (검색 결과 페이지)
     │       └── +page.server.ts (검색 로직)
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       └── queries/
     │   │           └── posts.ts (searchPosts 함수 추가)
     │   └── components/
     │       └── SearchBar.svelte (검색바 컴포넌트)
     ```
   - ✅ **구현 완료**:
     - 검색바 컴포넌트: Header에 통합 (데스크톱/모바일 반응형)
     - 검색 쿼리 함수: `searchPosts(query, { limit, offset })` - Supabase `ilike` 사용
     - 검색 결과 페이지: 쿼리 파라미터 `q` 읽기, 결과 목록 표시, 페이지네이션 지원
     - 검색 개수 조회: `getSearchPostCount(query)` 함수 추가

2. ✅ **페이지네이션** (12개/페이지)
   - ✅ **구현 완료**:
     - `/posts`, `/my-posts`, `/search`에 페이지네이션 적용
     - 쿼리 함수: `listPosts(limit, offset)`, `getPostCount()`, `getMyPosts(userId, limit, offset)`, `getMyPostCount(userId)`
     - UI 컴포넌트: `Pagination.svelte` (이전/다음, 페이지 번호)
     - 서버 로드: `page` 파라미터 파싱, `limit/offset` 계산, `totalPages` 계산

3. ✅ **댓글 시스템** (로그인 사용자 전용)
   - **파일 구조**:
     ```
     src/
     ├── routes/
     │   └── posts/
     │       └── [id]/
     │           └── +page.svelte (댓글 섹션 추가)
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       ├── queries/
     │   │       │   └── comments.ts (댓글 CRUD 함수)
     │   │       └── types.ts (Comment 타입 추가)
     │   └── components/
     │       ├── CommentList.svelte (댓글 목록)
     │       ├── CommentForm.svelte (댓글 작성 폼)
     │       └── CommentItem.svelte (댓글 아이템)
     ```
   - ✅ **데이터베이스 스키마**: `comments` 테이블 생성 완료 (인덱스 포함)
   - ✅ **구현 완료**:
     - 댓글 쿼리 함수: `listComments()`, `createComment()`, `updateComment()`, `deleteComment()` (`src/lib/server/supabase/queries/comments.ts`)
     - 댓글 컴포넌트: `CommentList.svelte`, `CommentForm.svelte`, `CommentItem.svelte`
     - 게시글 상세 페이지(`/posts/[id]`)에 댓글 섹션 통합
     - 로그인 사용자만 댓글 작성/수정/삭제 가능
     - 본인 댓글만 수정/삭제 가능

4. ✅ **좋아요 기능** (로그인 사용자 전용)
   - **파일 구조**:
     ```
     src/
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       ├── queries/
     │   │       │   └── likes.ts (좋아요 함수)
     │   │       └── types.ts (Like 타입 추가)
     │   └── components/
     │       └── LikeButton.svelte (좋아요 버튼)
     ```
   - ✅ **데이터베이스 스키마**: `likes` 테이블 생성 완료 (UNIQUE 제약조건, 인덱스 포함)
   - ✅ **구현 완료**:
     - 좋아요 쿼리 함수: `getLikeCount()`, `isLiked()`, `toggleLike()` (`src/lib/server/supabase/queries/likes.ts`)
     - LikeButton 컴포넌트: 하트 아이콘, 좋아요 개수 표시, 클릭 시 토글
     - 게시글 상세 페이지(`/posts/[id]`)에 LikeButton 컴포넌트 통합
     - 로그인 사용자만 좋아요 가능

### MVP 6단계: UI/UX 개선 (진행 중 🔄)
1. ✅ **모던 UI 리프레시** (완료)
   - ✅ 헤더: 라이트 톤 + 반투명 + backdrop-blur 스타일 (sticky, 글씨 가독성 개선)
   - ✅ 배경: 위스키 계열 그라데이션 + 노이즈 패턴 (`+layout.svelte`)
   - ✅ 전역 스타일: 폰트 렌더링, 포커스 링, 선택 색상 통일 (`app.css`)
   - ✅ 메인 페이지 정리: 게시글 목록/작성만 남기고 문의 카드 추가
   - ✅ 문의 페이지 추가: `/contact` 라우트 생성
   - ✅ 푸터: 밝은 반투명 톤으로 통일

2. 🔄 **반응형 디자인 세부 개선** (진행 예정)
   - **모바일 최적화** (< 640px):
     - Header: 햄버거 메뉴 또는 간소화된 네비게이션
     - 게시글 목록: 단일 컬럼, 카드 레이아웃
     - 버튼: 터치 친화적 크기 (최소 44x44px)
   - **태블릿 레이아웃** (640px - 1024px):
     - 게시글 목록: 2컬럼 그리드
     - 사이드바 또는 추가 정보 표시
   - **데스크톱 레이아웃** (> 1024px):
     - 최대 너비 제한 (예: max-w-7xl)
     - 최적화된 여백 및 간격
   - **Tailwind 반응형 클래스 활용**: `sm:`, `md:`, `lg:`, `xl:` 브레이크포인트 사용, Mobile First 접근

2. **사용자 경험 개선**
   - **로딩 상태**:
     - 스켈레톤 UI 컴포넌트 (`src/lib/components/Skeleton.svelte`)
     - SvelteKit `{#await}` 블록 활용
   - **에러 처리**:
     - 에러 페이지 개선 (`src/routes/+error.svelte`)
     - 폼 에러 처리: 실시간 유효성 검사, 필드별 에러 메시지
   - **피드백**:
     - 토스트 알림 시스템 (선택사항): `Toast.svelte`, `ToastContainer.svelte`
     - 성공 피드백: 글 작성/수정/삭제, 댓글 작성 성공 시 메시지
   - **페이지네이션**:
     - 게시글 목록 페이지네이션: 페이지당 게시글 수 제한 (예: 10개)
     - 쿼리 함수 업데이트: `listPosts(limit?, offset?)`, `getPostCount()`
     - 컴포넌트: `Pagination.svelte`

3. **성능 최적화**
   - **이미지 최적화** (향후 이미지 업로드 기능 추가 시):
     - Lazy loading
     - WebP 형식 지원
     - 썸네일 생성
   - **코드 스플리팅**: SvelteKit의 자동 코드 스플리팅 활용
   - **DB 최적화**: 인덱스 추가, 쿼리 최적화, 연결 풀링 (Supabase에서 자동 관리)

### 향후 추가 예정
- 이미지 업로드 (로컬 스토리지 또는 클라우드 스토리지)
- 사용자 프로필 페이지
- 북마크 기능
- 태그 시스템
- 위스키 정보 데이터베이스 (위스키 종류, 브랜드 등)

## 디자인 가이드
- **색감**: 위스키 커뮤니티 느낌의 따뜻한 톤 (골드, 앰버, 다크 브라운 계열)
- **반응형**: Mobile First 접근
- **UI**: 모던하고 깔끔한 디자인, Tailwind 기본 스타일 활용

## 금지 사항
- 일반 CSS 파일 작성 (Tailwind로 해결 불가능한 경우만 예외)
- 복잡한 상태 관리 (필요시만 간단한 store 사용)
- **Supabase Service Role Key 사용 금지**: 클라이언트에 노출되면 안 됨
- **Supabase 클라이언트를 클라이언트 사이드에서 직접 생성 금지**: `src/lib/server/supabase/client.ts`에서만 생성
- **DB 접근은 쿼리 계층을 통해서만**: `src/lib/server/supabase/queries/posts.ts`의 함수들을 사용

## 개발 프로세스 규칙
1. **구현**: 기능 개발
2. **테스트**: 구현 완료 후 반드시 테스트 수행
3. **문서 업데이트**: 테스트 완료 후 `.cursorrules`와 `web-dev-guidelines.md` 업데이트
   - 완료된 기능은 ✅ 표시
   - 진행 중인 작업은 🔄 표시
   - 예정된 작업은 명확히 구분

## UX 규칙 (상호작용)
- 좋아요/댓글 같은 “작은 액션”은 가능하면 **redirect 없이 `use:enhance`로 즉시 반영** (낙관적 업데이트 + 실패 시 롤백)

## Supabase 관련 규칙
- **환경 변수**: `PUBLIC_SUPABASE_URL`, `PUBLIC_SUPABASE_ANON_KEY` 사용
- **RLS (Row Level Security)**: MVP 단계에서는 비활성화하여 insert 가능하도록 설정
- **서버 전용**: `src/lib/server/supabase/client.ts`에서만 클라이언트 생성
- **쿼리 계층**: `src/lib/server/supabase/queries/posts.ts`가 DB 접근의 단일 창구
- **보안**: ANON_KEY는 RLS로 제어되므로 안전하지만, Service Role Key는 절대 사용하지 않음

## 추가 참조
- 상세 가이드라인: `web-dev-guidelines.md` 참조
- 마지막 업데이트: 2026-01-22 (Vercel 배포 반영)