# DramLog 개발 규칙

## 프로젝트 개요
- **프로젝트**: DramLog - 위스키 리뷰/게시글 커뮤니티 웹사이트
- **기술 스택**: SvelteKit + Tailwind CSS + Supabase
- **렌더링**: 서버사이드 렌더링(SSR) 기반
- **개발 모드**: 1인 개발 기준

## 핵심 원칙
- **Tailwind CSS만 사용**: 일반 CSS 작성 최소화, Tailwind 유틸리티 클래스 적극 활용
  - **예외 사항**:
    - `src/app.html`의 `style="display: contents"`: SvelteKit의 특수한 요구사항으로 인라인 스타일 필요
    - `src/lib/components/Toast.svelte`의 커스텀 키프레임 애니메이션: Tailwind의 arbitrary values로는 키프레임 정의가 불가능하므로 `<style>` 태그 사용 허용
- **컴포넌트 분리**: 작은 단위로 컴포넌트 분리, 재사용성 고려
- **SvelteKit 규칙 준수**: `+page.svelte`, `+layout.svelte`, `+page.server.ts` 등 파일 기반 라우팅 규칙 준수
- **Supabase 사용**: 데이터베이스는 Supabase 사용 (PostgreSQL16 기반)
- **서버 전용 클라이언트**: `src/lib/server/supabase/client.ts`에서만 Supabase 클라이언트 생성
- **보안**: Service Role Key 절대 사용 금지, 클라이언트 노출 금지
- **익명/로그인 구분 개발**: 로그인 필요 없는 익명 사용자와 로그인 사용자를 구분하여 작동하도록 코드 작성
  - 예시: `/write` 페이지에서 `$page.data.user`로 로그인 여부 확인
  - 로그인 사용자: 닉네임 자동 적용, 비밀번호 입력 불필요, `user_id`로 수정/삭제
  - 익명 사용자: 작성자 선택 입력, 비밀번호 필수, 비밀번호로 수정/삭제
  - 같은 페이지/라우트에서 조건부 렌더링과 서버 로직 분기로 구현
  - **권한 정책(강제)**:
    - 로그인 글(`user_id` 존재, `is_anonymous = false`): 작성자 본인만 수정/삭제 가능 (비밀번호 입력 없음)
    - 익명 글(`is_anonymous = true`): **user_id와 무관하게** 비밀번호로만 수정/삭제 가능
      - 익명 글도 익명 세션의 `user_id`를 가지지만, 토큰 만료 시 `user_id`가 바뀔 수 있으므로 비밀번호로만 관리
      - 로그아웃 상태에서만 비밀번호로 수정/삭제 가능 (로그인 상태에서는 수정/삭제 불가)

## 코딩 스타일
- 들여쓰기: 2 spaces
- 변수명: camelCase
- 컴포넌트명: PascalCase
- 주석: 한국어로 작성
- Tailwind 클래스: 의미있는 그룹핑, 가독성 고려

## Svelte 5 코딩 규칙 (필수)
- **Svelte 버전**: Svelte 5 사용 (2026-01-22부터)
- **새로운 컴포넌트**: 반드시 Runes 모드로 작성
- **기존 컴포넌트**: 점진적으로 Runes 모드로 마이그레이션
- **Props 선언**: `export let prop;` 대신 `let { prop } = $props();` 사용
- **반응성 변수**: 
  - 일반 변수: `let x = value;` (비반응성)
  - 반응성 변수: `let x = $state(value);` 사용
  - 파생 값: `$: y = x * 2;` 대신 `let y = $derived(x * 2);` 사용
- **사이드 이펙트**: `$: { ... }` 대신 `$effect(() => { ... });` 사용
- **이벤트 디스패처**: `createEventDispatcher()` 대신 함수 props 사용
  - `let { onevent } = $props();` 선언 후 `onevent?.(data);` 호출
- **SvelteKit stores**: `$page`, `$navigating` 등은 그대로 사용 가능 (변경 없음)
- **서버 사이드 코드**: `+page.server.ts` 등은 변경 없음

## TipTap Rich Text Editor 규칙 (필수)
- **공식 문서 패턴 준수**: TipTap 공식 문서의 Svelte 통합 가이드를 따라야 함
  - 참고: https://tiptap.dev/docs/editor/getting-started/install/svelte
- **상태 관리 패턴**:
  - `editorState = $state<{ editor: Editor | null }>({ editor: null })` 패턴 사용
  - 개별 버튼 상태 변수 사용 금지 (`isBoldActive`, `isItalicActive` 등)
  - `updateTrigger` 같은 수동 트리거 사용 금지
- **리렌더링 방식**:
  - `onTransaction` 콜백에서 `editorState = { editor }` 재할당으로 리렌더링 강제
  - `onUpdate`/`onSelectionUpdate` 대신 `onTransaction` 사용
- **템플릿 접근**:
  - 템플릿에서 직접 `editorState.editor?.isActive()` 호출
  - 상태 변수 대신 에디터 인스턴스 메서드 직접 사용
- **에디터 초기화**:
  - `setTimeout` 기반 대기 로직 사용 금지
  - `bind:this={editorRoot}` 사용, `onMount`에서 바로 초기화
  - 툴바는 `{#if editorState.editor}` 블록으로 조건부 렌더링
  - 에디터 영역(`<div bind:this={editorRoot}>`)은 항상 렌더링
- **이미지 삽입 규칙** (필수):
  - **TipTap Image Extension**: `ResizableImage` 사용 (커스텀 확장, `@tiptap/extension-image` 기반)
  - **초기 설정**: `ResizableImage.configure({ inline: true, allowBase64: false })` - width/height 속성 지원
  - **파일 형식 제한**: JPG, PNG, WebP, GIF만 허용 (클라이언트/서버 양쪽에서 검증)
  - **Blob URL 임시 표시**: 클라이언트에서 `URL.createObjectURL(file)`로 Blob URL 생성하여 에디터에 삽입
  - **File 객체 추적**: `Map<string, File>`로 Blob URL과 File 객체 매핑 저장
  - **onImageAdd 콜백**: RichTextEditor에서 `onImageAdd?: (blobUrl: string, file: File) => void` prop 제공
  - **발행 시 업로드**: 게시글 발행 시 Blob URL을 Supabase Storage URL로 변환
  - **HTML Sanitization**: `sanitizePostHtml` 함수에 `img` 태그 및 속성(`src`, `alt`, `title`, `width`, `height`, `class`) 허용

## 파일 구조 (SvelteKit)
```
src/
├── routes/
│   ├── +layout.svelte (공통 레이아웃)
│   ├── +layout.server.ts (전역 세션 로드)
│   ├── +page.svelte (메인 페이지)
│   ├── +error.svelte (에러 페이지)
│   ├── login/ (로그인)
│   ├── signup/ (회원가입)
│   ├── logout/ (로그아웃)
│   ├── my-posts/ (내 글 목록)
│   ├── bookmarks/ (북마크)
│   ├── search/ (검색 결과)
│   ├── contact/ (문의)
│   ├── posts/
│   │   ├── +page.svelte (게시글 리스트)
│   │   └── [id]/
│   │       ├── +page.svelte (게시글 상세)
│   │       └── edit/
│   │           └── +page.svelte (게시글 수정)
│   └── write/
│       └── +page.svelte (글 작성)
├── lib/
│   ├── components/ (재사용 컴포넌트)
│   │   ├── Header.svelte
│   │   ├── Footer.svelte
│   │   ├── PostCard.svelte
│   │   ├── SearchBar.svelte
│   │   ├── Pagination.svelte
│   │   ├── Skeleton.svelte
│   │   ├── LikeButton.svelte
│   │   ├── CommentForm.svelte
│   │   ├── CommentList.svelte
│   │   ├── CommentItem.svelte
│   │   ├── RichTextEditor.svelte
│   │   ├── Toast.svelte
│   │   └── ToastContainer.svelte
│   ├── client/
│   │   └── tiptap/
│   │       ├── resizableImage.ts (커스텀 TipTap Image 확장)
│   │       └── imageResize.ts (이미지 리사이즈 핸들 로직)
│   ├── stores/ (상태 관리)
│   │   └── toast.ts (토스트 알림 store)
│   └── server/ (서버 전용 코드)
│       └── supabase/
│           ├── client.ts (Supabase 클라이언트 생성)
│           ├── auth.ts (인증 헬퍼)
│           ├── types.ts (타입 정의)
│           └── queries/
│               ├── posts.ts (게시글 쿼리 함수)
│               ├── comments.ts (댓글 쿼리 함수)
│               ├── likes.ts (좋아요 쿼리 함수)
│               ├── storage.ts (이미지 업로드 함수)
│               └── images.ts (Blob URL 변환 함수)
├── app.css (Tailwind CSS)
└── app.html
```

## MVP 기능 (현재 단계 - 완료 ✅)
1. ✅ 메인 페이지: 커뮤니티 소개 + 최신 글 목록
2. ✅ 게시글 리스트 페이지
3. ✅ 게시글 상세 페이지
4. ✅ 글 작성 페이지 (Supabase 저장)
5. ✅ 공통 레이아웃 (헤더/푸터)
6. ✅ PostgreSQL 16 설치 및 데이터베이스 생성 완료 (레거시)
7. ✅ PostgreSQL 연결 및 마이그레이션 구현 (레거시)
8. ✅ 데이터베이스 스키마 생성 (posts 테이블)
9. ✅ 게시글 CRUD 기능 (생성, 조회, 목록)
10. ✅ 프로젝트 이름 DramLog로 통일
11. ✅ 날짜 2026-01-20 기준으로 업데이트
12. ✅ Supabase 통합 (글 작성/목록/상세 - 완전 전환 완료)
13. ✅ 게시글 수정 기능 (`/posts/[id]/edit`)
14. ✅ 게시글 삭제 기능 (상세 페이지)
15. ✅ 이미지 삽입 기능 (TipTap Image extension + Supabase Storage)

## 다음 단계 (우선순위 순)

### MVP 3단계: 게시글 관리 기능 (완료 ✅)
1. ✅ **게시글 수정 기능**
   - `/posts/[id]/edit` 라우트 생성 완료
   - 수정 폼 페이지 (`+page.svelte`) 구현 완료
   - 서버 액션으로 업데이트 (`updatePost` 함수) 구현 완료
   - 현재는 모든 사용자 수정 가능 (인증 전 단계)

2. ✅ **게시글 삭제 기능**
   - 게시글 상세 페이지에 삭제 버튼 추가 완료
   - 서버 액션으로 삭제 (`deletePost` 함수) 구현 완료
   - 삭제 확인 다이얼로그 (confirm) 구현 완료
   - 현재는 모든 사용자 삭제 가능 (인증 전 단계)

3. ✅ **쿼리 함수 추가**
   - `src/lib/server/supabase/queries/posts.ts`에 `updatePost`, `deletePost` 함수 구현 완료

### MVP 4단계: 익명 게시판 + 선택 로그인 (개인 DB) (완료 ✅)
1. ✅ **익명 게시글 작성 기능**
   - 로그인 없이 게시글 작성 가능
   - 기본 작성자명: `익명의 위스키 러버` (작성자명 입력은 선택사항)
   - 게시글 작성 시 비밀번호 필수 입력 (수정/삭제용)

2. ✅ **게시글 비밀번호 관리**
   - `posts` 테이블에 `edit_password_hash TEXT` 컬럼 추가
   - 서버에서 비밀번호를 scrypt 해시로 저장 (평문 저장 금지)
   - 수정/삭제 시 비밀번호 검증 (timing-safe 비교)

3. ✅ **데이터베이스 스키마**
   - `author_name TEXT NOT NULL DEFAULT '익명의 위스키 러버'`
   - `edit_password_hash TEXT` (익명 글이면 값 존재)
   - `user_id UUID` (선택 로그인 도입 시 사용, 게스트 글 Claim 없음)

4. ✅ **구현 완료**
   - `/write`: 비밀번호 입력 필드 추가, 작성자명 기본값 적용
   - `/posts/[id]/edit`: 비밀번호 입력 필드 추가, 비밀번호 검증
   - `/posts/[id]`: 삭제 시 비밀번호 입력 모달/폼, 비밀번호 검증
   - 쿼리 계층: `createPost()`, `updatePost()`, `deletePost()`에 비밀번호 해시/검증 로직 추가

5. ✅ **선택 로그인 기능** (Supabase Auth)
   - 라우트: `/login`, `/signup`, `/logout`, `/my-posts`
   - 로그인은 개인 DB(보유 위스키, 북마크 등)용으로만 사용
   - 내 글 목록: `/my-posts` (posts.user_id 기반)
   - **로그인 사용자 글 작성**: 닉네임(`user_metadata.nickname`) 자동 적용, 비밀번호 입력 불필요, `user_id`로 수정/삭제
   - **익명 글 작성**: 작성자 선택 입력, 비밀번호 필수, 비밀번호로 수정/삭제
   - 같은 페이지(`/write`)에서 로그인 여부에 따라 UI/로직 자동 분기
   - 게스트 글 Claim 기능 없음 (익명 글은 계속 익명 소유)

### MVP 5단계: 핵심 기능 강화 (완료 ✅)
1. ✅ **검색 기능**
   - **파일 구조**:
     ```
     src/
     ├── routes/
     │   └── search/
     │       ├── +page.svelte (검색 결과 페이지)
     │       └── +page.server.ts (검색 로직)
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       └── queries/
     │   │           └── posts.ts (searchPosts 함수 추가)
     │   └── components/
     │       └── SearchBar.svelte (검색바 컴포넌트)
     ```
   - ✅ **구현 완료**:
     - 검색바 컴포넌트: Header에 통합 (데스크톱/모바일 반응형)
     - 검색 쿼리 함수: `searchPosts(query, { limit, offset })` - Supabase `ilike` 사용
     - 검색 결과 페이지: 쿼리 파라미터 `q` 읽기, 결과 목록 표시, 페이지네이션 지원
     - 검색 개수 조회: `getSearchPostCount(query)` 함수 추가

2. ✅ **페이지네이션** (12개/페이지)
   - ✅ **구현 완료**:
     - `/posts`, `/my-posts`, `/search`에 페이지네이션 적용
     - 쿼리 함수: `listPosts(limit, offset)`, `getPostCount()`, `getMyPosts(userId, limit, offset)`, `getMyPostCount(userId)`
     - UI 컴포넌트: `Pagination.svelte` (이전/다음, 페이지 번호)
     - 서버 로드: `page` 파라미터 파싱, `limit/offset` 계산, `totalPages` 계산

3. ✅ **댓글 시스템** (로그인 사용자 전용)
   - **파일 구조**:
     ```
     src/
     ├── routes/
     │   └── posts/
     │       └── [id]/
     │           └── +page.svelte (댓글 섹션 추가)
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       ├── queries/
     │   │       │   └── comments.ts (댓글 CRUD 함수)
     │   │       └── types.ts (Comment 타입 추가)
     │   └── components/
     │       ├── CommentList.svelte (댓글 목록)
     │       ├── CommentForm.svelte (댓글 작성 폼)
     │       └── CommentItem.svelte (댓글 아이템)
     ```
   - ✅ **데이터베이스 스키마**: `comments` 테이블 생성 완료 (인덱스 포함)
   - ✅ **구현 완료**:
     - 댓글 쿼리 함수: `listComments()`, `createComment()`, `updateComment()`, `deleteComment()` (`src/lib/server/supabase/queries/comments.ts`)
     - 댓글 컴포넌트: `CommentList.svelte`, `CommentForm.svelte`, `CommentItem.svelte`
     - 게시글 상세 페이지(`/posts/[id]`)에 댓글 섹션 통합
     - 로그인 사용자만 댓글 작성/수정/삭제 가능
     - 본인 댓글만 수정/삭제 가능

4. ✅ **좋아요 기능** (로그인 사용자 전용)
   - **파일 구조**:
     ```
     src/
     ├── lib/
     │   ├── server/
     │   │   └── supabase/
     │   │       ├── queries/
     │   │       │   └── likes.ts (좋아요 함수)
     │   │       └── types.ts (Like 타입 추가)
     │   └── components/
     │       └── LikeButton.svelte (좋아요 버튼)
     ```
   - ✅ **데이터베이스 스키마**: `likes` 테이블 생성 완료 (UNIQUE 제약조건, 인덱스 포함)
   - ✅ **구현 완료**:
     - 좋아요 쿼리 함수: `getLikeCount()`, `isLiked()`, `toggleLike()` (`src/lib/server/supabase/queries/likes.ts`)
     - LikeButton 컴포넌트: 하트 아이콘, 좋아요 개수 표시, 클릭 시 토글
   - 게시글 상세 페이지(`/posts/[id]`)에 LikeButton 컴포넌트 통합
   - 로그인 사용자만 좋아요 가능

5. ✅ **조회수 집계**
   - `posts` 테이블에 `view_count` 컬럼 추가
   - `increment_post_view()` 함수로 안전하게 증가 (RLS 우회)
   - 쿠키 기반 중복 방지 (24시간)

### MVP 7단계: Supabase Anonymous Auth + RLS 설정 (완료 ✅)
1. ✅ **Supabase Anonymous Auth 구현**
   - 익명 사용자도 세션을 가지도록 `createAnonymousSession()` 함수 구현
   - `getUserOrCreateAnonymous()` 함수로 세션이 없으면 자동으로 익명 세션 생성
   - 익명 사용자는 `isAnonymous: true`로 식별
   - 익명 사용자는 헤더에서 "내 글" 메뉴가 보이지 않도록 처리

2. ✅ **RLS (Row Level Security) 정책 설정**
   - `posts`, `comments`, `likes` 테이블에 RLS 활성화
   - 읽기 정책: 모든 사용자 읽기 가능
   - 쓰기 정책: 인증된 사용자(익명 포함)만 작성 가능
   - 수정/삭제 정책: 작성자만 수정/삭제 가능 (`auth.uid() = user_id`)
   - 익명 글은 `is_anonymous` 컬럼으로 식별
   - RLS 정책: `is_anonymous = true`인 경우 업데이트/삭제 허용

3. ✅ **세션 토큰 기반 클라이언트 생성**
   - `createSupabaseClientWithSession()` 함수 구현
   - RLS 정책에서 `auth.uid()`를 사용할 수 있도록 세션 토큰 전달
   - `SessionTokens` 객체를 받아서 Authorization 헤더에 추가

4. ✅ **익명 글 관리 개선**
   - `is_anonymous` 컬럼 추가하여 익명 글 명확히 식별
   - 익명 글 작성 시 `is_anonymous: true` 설정
   - 익명 글 수정/삭제 시 비밀번호 검증 로직 개선
   - 로그인 상태에서는 익명 글 수정/삭제 불가 정책 적용

5. ✅ **익명 사용자 회원가입 시 글 전환 기능**
   - `convertAnonymousPostsToUserPosts()` 함수 구현
   - 익명 사용자 회원가입 시 기존 익명 글을 회원 글로 자동 전환
   - `updateUser()`로 익명 사용자 ID 유지 시도 (실패 시 `signUp()`으로 폴백)
   - 세션 만료 감지 로직 추가
   - 회원가입 완료 후 로그인 페이지에 익명 글 전환 정보 표시

6. ✅ **버그 수정**
   - `toast.ts`의 `remove` 함수 클로저 문제 해결
   - `use:enhance`의 `result` null 체크 추가
   - `verifyEditPassword` 함수 타입 안전성 개선
   - `createSupabaseClientWithSession` 함수 시그니처 수정

### MVP 6단계: UI/UX 개선 (완료 ✅)
1. ✅ **모던 UI 리프레시** (완료)
   - ✅ 헤더: 라이트 톤 + 반투명 + backdrop-blur 스타일 (sticky, 글씨 가독성 개선)
   - ✅ 배경: 위스키 계열 그라데이션 + 노이즈 패턴 (`+layout.svelte`)
   - ✅ 전역 스타일: 폰트 렌더링, 포커스 링, 선택 색상 통일 (`app.css`)
   - ✅ 메인 페이지 정리: 게시글 목록/작성만 남기고 문의 카드 추가
   - ✅ 문의 페이지 추가: `/contact` 라우트 생성
   - ✅ 푸터: 밝은 반투명 톤으로 통일

2. ✅ **반응형 디자인 세부 개선** (완료)
   - **모바일 최적화** (< 640px):
     - Header: 햄버거 메뉴 또는 간소화된 네비게이션
     - 게시글 목록: 단일 컬럼, 카드 레이아웃
     - 버튼: 터치 친화적 크기 (최소 44x44px)
   - **태블릿 레이아웃** (640px - 1024px):
     - 게시글 목록: 2컬럼 그리드
     - 사이드바 또는 추가 정보 표시
   - **데스크톱 레이아웃** (> 1024px):
     - 최대 너비 제한 (예: max-w-7xl)
     - 최적화된 여백 및 간격
   - **Tailwind 반응형 클래스 활용**: `sm:`, `md:`, `lg:`, `xl:` 브레이크포인트 사용, Mobile First 접근

2. **사용자 경험 개선**
   - **로딩 상태**:
     - ✅ 스켈레톤 UI 컴포넌트 (`src/lib/components/Skeleton.svelte`) - 구현 완료, `/posts`, `/search` 페이지에서 사용 중
     - SvelteKit `{#await}` 블록 활용
   - **에러 처리**:
     - ✅ 에러 페이지 개선 (`src/routes/+error.svelte`) - 404, 403, 500 등 에러 코드별 메시지 개선
     - ✅ 폼 에러 처리: 실시간 유효성 검사, 필드별 에러 메시지
       - ✅ 클라이언트 사이드 실시간 검증 (`on:input`, `on:blur`)
       - ✅ `touchedFields` 패턴으로 초기 로드 시 에러 표시 방지
       - ✅ Svelte 반응성 보장 (객체 재할당 패턴)
       - ✅ 서버/클라이언트 에러 병합 (`allFieldErrors`)
   - **피드백**:
     - ✅ 토스트 알림 시스템: `Toast.svelte`, `ToastContainer.svelte`, `toast.ts` store - 구현 완료
     - ✅ 성공 피드백: 글 작성/수정/삭제 시 토스트 메시지 표시
   - **브라우저 자동완성 방지**:
     - ✅ `autocomplete` 속성 추가 (`excerpt`: `off`, `editPassword`: `new-password`, `editPasswordConfirm`: `new-password`)
     - ✅ 로그인 정보가 게시글 작성 폼에 자동 채워지는 문제 해결
   - **페이지네이션**:
     - ✅ 게시글 목록 페이지네이션: 12개/페이지 (`/posts`, `/my-posts`, `/search`)
     - ✅ 쿼리 함수: `listPosts(limit, offset)`, `getPostCount()` 등
     - ✅ 컴포넌트: `Pagination.svelte`

3. **성능 최적화**
   - **이미지 최적화** (향후 추가 예정):
     - ✅ 기본 업로드 기능 구현 완료 (Supabase Storage)
   - ✅ 이미지 압축 기능 (클라이언트 리사이즈/압축)
     - Lazy loading
     - WebP 형식 지원
     - 썸네일 생성
   - **코드 스플리팅**: SvelteKit의 자동 코드 스플리팅 활용
   - **DB 최적화**: 인덱스 추가, 쿼리 최적화, 연결 풀링 (Supabase에서 자동 관리)

### 향후 추가 예정
- ✅ 이미지 업로드 (Supabase Storage) - 기본 기능 구현 완료
- ✅ 이미지 압축 기능 (클라이언트 리사이즈/압축)
- ✅ 사용자 프로필 페이지 (프로필 편집)
- ✅ 북마크 기능 (북마크 테이블 + 목록/토글)
- ✅ 태그 시스템 (태그 입력/검색/필터)
- ✅ 위스키 정보 데이터베이스 (위스키 종류, 브랜드 등)

## 디자인 가이드
- **색감**: 위스키 커뮤니티 느낌의 따뜻한 톤 (골드, 앰버, 다크 브라운 계열)
- **반응형**: Mobile First 접근
- **UI**: 모던하고 깔끔한 디자인, Tailwind 기본 스타일 활용

## 금지 사항
- 일반 CSS 파일 작성 (Tailwind로 해결 불가능한 경우만 예외)
- 복잡한 상태 관리 (필요시만 간단한 store 사용)
- **Supabase Service Role Key 사용 금지**: 클라이언트에 노출되면 안 됨
- **Supabase 클라이언트를 클라이언트 사이드에서 직접 생성 금지**: `src/lib/server/supabase/client.ts`에서만 생성
- **DB 접근은 쿼리 계층을 통해서만**: `src/lib/server/supabase/queries/posts.ts`의 함수들을 사용

## 개발 프로세스 규칙
1. **구현**: 기능 개발
2. **테스트**: 구현 완료 후 반드시 테스트 수행
3. **문서 업데이트**: 테스트 완료 후 `.cursorrules`와 `web-dev-guidelines.md` 업데이트
   - 완료된 기능은 ✅ 표시
   - 진행 중인 작업은 🔄 표시
   - 예정된 작업은 명확히 구분

## 코드 리뷰 규칙 (필수)
- **순서**: `.cursorrules` 위반 → 런타임/빌드 오류 → 로직/보안 → 비표준/비일관 패턴 → 테스트 갭
- **제시 방식**: 각 이슈마다 관련 규칙 인용, 문제 설명, 개선 코드, 변경 이유 포함
- **판단 기준**: 프로덕션 기준으로 위험도(치명/높음/중간/낮음) 표시
- **불확실성**: 규칙이 모호하면 해석 기준을 명시
- **범위**: 파일 구조 → 서버 로직 → 클라이언트 로직 → 상태/비동기 → 스타일 순으로 검토

## 라이브러리 추가 규칙 (필수)
**새로운 npm 패키지를 추가하기 전에 반드시 다음을 확인해야 함:**
1. **버전 호환성 확인**:
   - 현재 프로젝트의 주요 의존성 버전 확인 (`package.json` 참조)
     - Svelte: `^5.0.0` (Svelte 5 사용)
     - Vite: `^5.0.3` (Vite 5 사용)
     - SvelteKit: `^2.50.0`
     - `@sveltejs/vite-plugin-svelte`: `^4.0.0` (Vite 5 호환)
   - 추가하려는 패키지의 `peerDependencies` 확인
   - npm 패키지 페이지에서 호환성 정보 확인
   - **버전 충돌이 발생하면 절대 설치하지 말고, 호환되는 버전을 찾거나 대안 패키지 검토**
2. **설치 전 확인 사항**:
   - `npm install <package>` 실행 전에 `package.json`에 버전 추가만 하고 실제 설치 전에 호환성 확인
   - `npm install` 실행 시 `ERESOLVE` 에러가 발생하면 즉시 중단하고 버전 조정
   - `--force` 또는 `--legacy-peer-deps` 플래그 사용 금지 (호환성 문제를 숨기는 것이므로)
3. **호환성 문제 발생 시**:
   - 패키지 버전을 다운그레이드하거나 업그레이드하여 호환되는 버전 찾기
   - 대안 패키지 검토
   - 프로젝트의 주요 의존성 버전 업그레이드 검토 (신중하게 진행)
4. **예시 사례**:
   - ❌ `svelte-tiptap@^2.0.0` 추가 시도 → `@tiptap/core@^2.11.5` 요구하지만 프로젝트는 `@tiptap/core@^3.17.1` 사용 → 버전 충돌
   - ❌ `@sveltejs/vite-plugin-svelte@^5.0.0` 추가 시도 → `vite@^6.0.0` 요구하지만 프로젝트는 `vite@^5.0.3` 사용 → 버전 충돌
   - ✅ 호환되는 버전 확인 후 추가 또는 대안 패키지 사용

## 문제 해결 프로세스 (필수)
**버그나 기능 오작동이 보고되면 반드시 다음 순서로 진행:**
1. **브라우저 직접 테스트**: 문제가 발생한 페이지로 이동하여 실제로 기능을 시현
   - 브라우저 자동화 도구(MCP browser tools)를 사용하여 해당 페이지에서 직접 조작
   - 사용자가 보고한 문제를 재현 시도
   - 콘솔 에러, 네트워크 요청, 페이지 상태를 확인
2. **원인 분석**: 브라우저 테스트 결과를 바탕으로 문제 원인 파악
   - 서버 로직, 클라이언트 로직, 데이터베이스 쿼리 등을 순차적으로 확인
   - 에러 메시지, 로그, 네트워크 응답을 분석
3. **수정 및 재테스트**: 수정 후 브라우저에서 다시 테스트하여 문제 해결 확인
4. **문서 업데이트**: 문제 해결 방법이나 주의사항을 문서에 반영

## UX 규칙 (상호작용)
- 좋아요/댓글 같은 "작은 액션"은 가능하면 **redirect 없이 `use:enhance`로 즉시 반영** (낙관적 업데이트 + 실패 시 롤백)
- **File 업로드가 포함된 폼**: `use:enhance` 사용 금지, 수동 FormData + fetch 사용

## 폼 검증 규칙 (필수)
- **Svelte 반응성 보장**: 반응형 객체(`clientFieldErrors` 등)의 속성을 `delete`할 때는 반드시 객체를 재할당해야 함
  - ❌ 잘못된 예: `delete clientFieldErrors.title;`
  - ✅ 올바른 예: 
    ```javascript
    clientFieldErrors = { ...clientFieldErrors };
    delete clientFieldErrors.title;
    ```
  - 또는 더 간단하게:
    ```javascript
    clientFieldErrors = { ...clientFieldErrors, title: '에러 메시지' }; // 에러 추가
    clientFieldErrors = { ...clientFieldErrors }; delete clientFieldErrors.title; // 에러 제거
    ```
- **실시간 검증**: `on:input` 핸들러에서 직접 validation 함수를 호출하여 즉시 피드백 제공
- **touchedFields 패턴**: 필드가 blur되거나 입력이 시작된 경우에만 에러 표시 (초기 로드 시 에러 표시 방지)
- **서버/클라이언트 에러 병합**: `allFieldErrors = { ...clientFieldErrors, ...fieldErrors }` (서버 에러가 우선)

## Supabase 관련 규칙
- **환경 변수**: `PUBLIC_SUPABASE_URL`, `PUBLIC_SUPABASE_ANON_KEY` 사용
- **RLS (Row Level Security)**: ✅ RLS 정책 활성화 완료 (읽기/쓰기/수정/삭제 정책 설정)
- **Anonymous Auth**: ✅ 익명 인증 구현 완료 (익명 사용자도 세션을 가지도록 함)
- **서버 전용**: `src/lib/server/supabase/client.ts`에서만 클라이언트 생성
- **쿼리 계층**: `src/lib/server/supabase/queries/posts.ts`가 DB 접근의 단일 창구
- **보안**: ANON_KEY는 RLS로 제어되므로 안전하지만, Service Role Key는 절대 사용하지 않음
- **세션 토큰**: RLS 정책 적용을 위해 `createSupabaseClientWithSession()` 함수 사용 (SessionTokens 객체 전달)
- **Supabase Storage** (이미지 업로드):
  - ✅ Storage 버킷: `post-images` (공개 버킷)
  - ✅ RLS 정책: 읽기(모든 사용자), 쓰기(인증된 사용자), 삭제(업로드한 사용자)
  - ✅ 파일 경로: `posts/{userId}/{postId}/image_{index}.{extension}` (리소스 타입 기반 구조)
  - ✅ 쿼리 함수: `src/lib/server/supabase/queries/storage.ts`의 `uploadImage()` 사용
  - ✅ Blob URL 변환: `src/lib/server/supabase/queries/images.ts`의 `convertBlobUrlsToStorageUrls()` 사용
  - ✅ 파일 형식 검증: JPG, PNG, WebP, GIF (클라이언트/서버 양쪽에서 검증)
  - ✅ 파일명 확장자로 MIME 타입 추론 (서버에서 `file.type`이 없을 경우)
  - ✅ 게시글 삭제 시 이미지 자동 삭제: `deletePostImages()` 함수로 폴더 전체 삭제
  - ✅ 게시글 수정 시 이미지 관리: 삭제된 이미지 자동 삭제, 새 이미지 업로드

## FormData + File 업로드 규칙 (필수)
**SvelteKit에서 File 객체를 전송할 때는 반드시 다음 규칙을 따라야 함:**
1. **`use:enhance` 사용 금지**: File 객체가 문자열 `"[object File]"`로 변환되는 문제 발생
2. **수동 FormData 생성**: 
   - ❌ `new FormData(e.target as HTMLFormElement)` (form 기반)
   - ✅ `new FormData()` (완전 수동 생성)
3. **모든 필드 직접 append**:
   ```typescript
   const formData = new FormData();
   formData.append('title', title);
   formData.append('content', content);
   // File 추가 시 세 번째 인자 file.name 명시 (매우 중요!)
   formData.append(`image_${index}`, file, file.name);
   ```
4. **action 이름 명시적 지정**:
   - ❌ `default` action은 form submit 전용, fetch로 호출 불가
   - ✅ 명시적 action 이름 사용 (`create`, `update` 등)
   - ✅ `fetch('?/create', { method: 'POST', body: formData })`
5. **onsubmit 핸들링**:
   ```typescript
   <form onsubmit={handleSubmit}>
   async function handleSubmit(e: SubmitEvent) {
     e.preventDefault();
     const formData = new FormData();
     // ... 필드 추가
     const res = await fetch('?/create', { method: 'POST', body: formData });
     const result = await res.json();
     // redirect 타입도 처리
     if (result.type === 'success' || result.type === 'redirect') {
       if (result.location) window.location.href = result.location;
     }
   }
   ```
6. **이미지 파일 추적**:
   - 클라이언트에서 `Map<string, File>`로 Blob URL과 File 객체 매핑
   - HTML에서 Blob URL 추출 후 해당 File 객체를 FormData에 추가
   - 서버에서 Blob URL을 Supabase Storage URL로 변환

## 추가 참조
- 상세 가이드라인: `web-dev-guidelines.md` 참조
- 마지막 업데이트: 2026-01-26 (검색 필터, 알림, 대표 이미지 선택)
